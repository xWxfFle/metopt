# Многоэтапная задача оптимизации инвестиционного портфеля

**Ф.И.О.:** Филатов Арсений Сергеевич  
**Поток:** 1.2

## Цель работы

Разработать план управления закупками/продажами ценных бумаг и депозитов для максимизации суммарного ожидаемого дохода инвестора на трехэтапном периоде планирования с учетом вероятностных ситуаций на рынке. Решение задачи выполняется методом динамического программирования с использованием рекуррентного соотношения Беллмана.

## Постановка задачи

### Исходные данные

**Начальное состояние портфеля:**
- Ценные бумаги типа 1 (ЦБ1): 100 д.е.
- Ценные бумаги типа 2 (ЦБ2): 800 д.е.
- Депозиты (Деп.): 400 д.е.
- Свободные средства: 600 д.е.
- **Общая стоимость портфеля: 1900 д.е.**

**Шаговое управление:**
Изменение объема фондов на один или несколько пакетов, где один пакет равен 1/4 от первоначальной стоимости:
- ЦБ1: 25 д.е. (100 / 4)
- ЦБ2: 200 д.е. (800 / 4)
- Деп.: 100 д.е. (400 / 4)

**Ограничения:**
- При увеличении объемов ценных бумаг и депозитов инвестор не может брать кредит
- Можно распоряжаться только свободными средствами
- Нельзя продать больше, чем имеется в наличии
- **Минимальные значения активов**:
  - ЦБ1 >= 30 д.е.
  - ЦБ2 >= 150 д.е.
  - Депозиты >= 100 д.е.

**Комиссии брокеров**:
- При покупке: ЦБ1 - 4%, ЦБ2 - 7%, Депозиты - 5%
- При продаже: комиссия вычитается из выручки (получаем меньше денег)

### Вероятностные ситуации по этапам

#### Этап 1

| Ситуация | Вероятность | Коэффициент ЦБ1 | Коэффициент ЦБ2 | Коэффициент Деп. |
|----------|-------------|-----------------|-----------------|-------------------|
| Благоприятная | 0.60 | 1.20 | 1.10 | 1.07 |
| Нейтральная | 0.30 | 1.05 | 1.02 | 1.03 |
| Негативная | 0.10 | 0.80 | 0.95 | 1.00 |

#### Этап 2

| Ситуация | Вероятность | Коэффициент ЦБ1 | Коэффициент ЦБ2 | Коэффициент Деп. |
|----------|-------------|-----------------|-----------------|-------------------|
| Благоприятная | 0.30 | 1.40 | 1.15 | 1.01 |
| Нейтральная | 0.20 | 1.05 | 1.00 | 1.00 |
| Негативная | 0.50 | 0.60 | 0.90 | 1.00 |

#### Этап 3

| Ситуация | Вероятность | Коэффициент ЦБ1 | Коэффициент ЦБ2 | Коэффициент Деп. |
|----------|-------------|-----------------|-----------------|-------------------|
| Благоприятная | 0.40 | 1.15 | 1.12 | 1.05 |
| Нейтральная | 0.40 | 1.05 | 1.01 | 1.01 |
| Негативная | 0.20 | 0.70 | 0.94 | 1.00 |

## Математическая формулировка задачи динамического программирования

### Обозначения

- **k** ∈ {0, 1, 2, 3} — номер этапа (k = 0 — начальное состояние, k = 1, 2, 3 — этапы планирования)
- **s_k** = (cb1_k, cb2_k, dep_k, cash_k) — состояние портфеля на этапе k:
  - cb1_k — объем ЦБ1
  - cb2_k — объем ЦБ2
  - dep_k — объем депозитов
  - cash_k — свободные средства
- **u_k** = (Δcb1_k, Δcb2_k, Δdep_k) — управление на этапе k (изменения в единицах шагов)
- **w_k** ∈ {благоприятная, нейтральная, негативная} — случайная ситуация на этапе k
- **p_k(w_k)** — вероятность ситуации w_k на этапе k
- **f_k(s_k, u_k, w_k)** — функция перехода состояния
- **F_k(s_k)** — максимальный ожидаемый доход от этапа k до конца при начальном состоянии s_k

### Функция перехода состояния

Состояние изменяется в два этапа:

1. **Применение управления:**
   ```
   cb1_k' = cb1_k + Δcb1_k · 25
   cb2_k' = cb2_k + Δcb2_k · 200
   dep_k' = dep_k + Δdep_k · 100
   cash_k' = cash_k - (Δcb1_k · 25 + Δcb2_k · 200 + Δdep_k · 100)
   ```

2. **Применение случайной ситуации:**
   ```
   cb1_{k+1} = cb1_k' · k_cb1(w_k)
   cb2_{k+1} = cb2_k' · k_cb2(w_k)
   dep_{k+1} = dep_k' · k_dep(w_k)
   cash_{k+1} = cash_k'
   ```

где k_cb1(w_k), k_cb2(w_k), k_dep(w_k) — коэффициенты изменения стоимости для ситуации w_k.

### Ограничения

1. **Ограничение на свободные средства (с учетом комиссий):**
   ```
   cost(Δcb1_k, Δcb2_k, Δdep_k) ≤ cash_k
   ```
   где `cost()` учитывает комиссии:
   - При покупке: стоимость = номинальная_стоимость × (1 + комиссия)
   - При продаже: выручка = номинальная_стоимость × (1 - комиссия)

2. **Ограничение на продажу:**
   ```
   cb1_k + Δcb1_k · 25 ≥ 0
   cb2_k + Δcb2_k · 200 ≥ 0
   dep_k + Δdep_k · 100 ≥ 0
   ```

3. **Минимальные ограничения на активы:**
   ```
   cb1_k + Δcb1_k · 25 ≥ 30
   cb2_k + Δcb2_k · 200 ≥ 150
   dep_k + Δdep_k · 100 ≥ 100
   ```

4. **Неотрицательность:**
   ```
   cb1_k ≥ 0, cb2_k ≥ 0, dep_k ≥ 0, cash_k ≥ 0
   ```

### Целевая функция

Максимизация ожидаемого суммарного дохода (критерий Байеса):
```
max E[cb1_3 + cb2_3 + dep_3 + cash_3]
```

где ожидание берется по всем возможным последовательностям ситуаций w_1, w_2, w_3.

## Рекуррентное соотношение Беллмана

### Общий вид

Для задачи динамического программирования с N этапами рекуррентное соотношение Беллмана имеет вид:

```
F_k(s_k) = max_{u_k ∈ U_k(s_k)} E_{w_k}[F_{k+1}(f_k(s_k, u_k, w_k))]

F_N(s_N) = cb1_N + cb2_N + dep_N + cash_N  (граничное условие)
```

где:
- **U_k(s_k)** — множество допустимых управлений из состояния s_k
- **E_{w_k}** — математическое ожидание по случайной ситуации w_k
- **f_k(s_k, u_k, w_k)** — функция перехода состояния

### Описание обратного и прямого прохождения

**Обратное прохождение (backward induction):**
1. Начинаем с последнего этапа (k = N)
2. Для каждого возможного состояния s_N вычисляем F_N(s_N) = общая стоимость портфеля
3. Для каждого предыдущего этапа k = N-1, N-2, ..., 1:
   - Для каждого состояния s_k находим оптимальное управление u_k*, максимизирующее ожидаемое значение F_{k+1}
   - Сохраняем F_k(s_k) и u_k*(s_k)
4. В результате получаем оптимальную стратегию для всех состояний

**Прямое прохождение:**
1. Начинаем с начального состояния s_0
2. На каждом этапе k применяем найденное оптимальное управление u_k*(s_k)
3. Применяем случайную ситуацию w_k (в реальности выбирается случайно, в расчетах используем ожидаемое значение)
4. Переходим к следующему этапу

### Рекуррентное соотношение для конкретной задачи

Для нашей задачи с тремя этапами:

**Граничное условие (этап 3, после применения ситуации):**
```
F_3(s_3) = cb1_3 + cb2_3 + dep_3 + cash_3
```

**Этап 2:**
```
F_2(s_2) = max_{u_2 ∈ U_2(s_2)} E_{w_2}[F_3(f_2(s_2, u_2, w_2))]

        = max_{u_2} Σ_{w_2} p_2(w_2) · F_3(f_2(s_2, u_2, w_2))
```

**Этап 1:**
```
F_1(s_1) = max_{u_1 ∈ U_1(s_1)} E_{w_1}[F_2(f_1(s_1, u_1, w_1))]

        = max_{u_1} Σ_{w_1} p_1(w_1) · F_2(f_1(s_1, u_1, w_1))
```

**Этап 0 (начальное состояние):**
```
F_0(s_0) = max_{u_0 ∈ U_0(s_0)} E_{w_0}[F_1(f_0(s_0, u_0, w_0))]

        = max_{u_0} Σ_{w_0} p_0(w_0) · F_1(f_0(s_0, u_0, w_0))
```

**Оптимальное значение:**
```
F_0(s_0) = максимальный ожидаемый доход
```

## Алгоритм решения

### Оптимизации для ускорения вычислений

Для решения задачи в разумное время были применены следующие оптимизации:

1. **Дискретизация состояний:**
   - Состояния округляются при хешировании и сравнении для уменьшения размера пространства состояний
   - ЦБ1 округляется до 50 д.е.
   - ЦБ2 округляется до 100 д.е.
   - Депозиты округляются до 50 д.е.
   - Свободные средства округляются до 100 д.е.
   - Это позволяет эффективно использовать кэш мемоизации

2. **Ограничение диапазона действий:**
   - Параметр `max_steps = 3` ограничивает максимальное количество шагов в каждом направлении
   - Это уменьшает количество рассматриваемых действий, сохраняя при этом возможность найти оптимальное решение

3. **Мемоизация:**
   - Результаты вычислений для каждой пары (этап, состояние) сохраняются в кэше
   - Это исключает повторные вычисления для одинаковых подзадач

### Псевдокод основного алгоритма

```
АЛГОРИТМ: Динамическое программирование для оптимизации портфеля

ВХОД:
  initial_state: начальное состояние портфеля
  stage_data: данные по этапам (вероятности и коэффициенты)
  step_sizes: размеры шагов управления

ВЫХОД:
  optimal_value: максимальный ожидаемый доход
  optimal_path: последовательность оптимальных действий

ФУНКЦИЯ BellmanRecursion(stage, state):
  ЕСЛИ stage >= количество_этапов:
    ВОЗВРАТИТЬ total_value(state), NULL
  
  // Дискретизация состояния для оптимизации кэша
  discretized_state = discretize(state)
  
  ЕСЛИ (stage, discretized_state) в кэше:
    ВОЗВРАТИТЬ значение из кэша
  
  best_value = -∞
  best_action = NULL
  
  // Ограничиваем диапазон действий параметром max_steps
  ДЛЯ каждого действия u из допустимых_действий(state, max_steps):
    new_state = apply_action(state, u)
    
    expected_value = 0
    ДЛЯ каждой ситуации w с вероятностью p:
      state_after = apply_situation(new_state, stage, w)
      future_value, _ = BellmanRecursion(stage + 1, state_after)
      expected_value += p * future_value
    
    ЕСЛИ expected_value > best_value:
      best_value = expected_value
      best_action = u
  
  Сохранить (stage, discretized_state) -> (best_value, best_action) в кэш
  ВОЗВРАТИТЬ best_value, best_action

ФУНКЦИЯ Solve():
  Очистить кэш
  current_state = initial_state
  optimal_path = []
  
  ДЛЯ stage от 0 до количество_этапов - 1:
    optimal_value, optimal_action = BellmanRecursion(stage, current_state)
    
    ЕСЛИ optimal_action == NULL:
      ПРЕРВАТЬ
    
    new_state = apply_action(current_state, optimal_action)
    Добавить (optimal_action, new_state) в optimal_path
    
    // Применяем ожидаемую ситуацию (критерий Байеса)
    expected_state = вычисляем_ожидаемое_состояние(new_state, stage)
    current_state = expected_state
  
  ВОЗВРАТИТЬ current_state.total_value(), optimal_path
```

### Описание основных функций

1. **`get_all_possible_actions(state)`** — генерирует все допустимые действия из текущего состояния с учетом ограничений на свободные средства и объемы активов. Ограничивает диапазон действий параметром `max_steps` для ускорения вычислений.

2. **`apply_action(state, action)`** — применяет действие к состоянию, изменяя объемы активов и свободные средства с учетом комиссий. Обеспечивает соблюдение минимальных ограничений на активы.

3. **`apply_situation(state, stage, situation)`** — применяет случайную ситуацию, изменяя стоимость активов согласно коэффициентам.

4. **`bellman_recursion(stage, state)`** — рекурсивная функция, реализующая рекуррентное соотношение Беллмана с мемоизацией для ускорения вычислений. Использует дискретизацию состояний для оптимизации работы кэша.

5. **`solve()`** — основная функция решения, которая находит оптимальную стратегию и применяет ее к начальному состоянию. Использует критерий Байеса для оценки ожидаемого состояния после каждого этапа.

6. **`solve_with_trace()`** — расширенная версия функции решения, которая дополнительно строит дерево всех возможных сценариев для детального анализа.

7. **`_build_scenario_tree(stage, state, path, scenarios)`** — рекурсивная функция для построения полного дерева всех возможных сценариев развития ситуации с учетом оптимальных действий на каждом этапе.

## Демонстрационные примеры

### Пример 1: Базовое решение

При запуске программы будет выполнено решение задачи с начальными данными:

```
Начальное состояние портфеля:
  ЦБ1: 100.0 д.е.
  ЦБ2: 800.0 д.е.
  Депозиты: 400.0 д.е.
  Свободные средства: 600.0 д.е.
  Общая стоимость: 1900.0 д.е.
```

Программа найдет оптимальную стратегию управления и выведет:
- Максимальный ожидаемый доход
- Последовательность оптимальных действий для каждого этапа
- Состояния портфеля после каждого действия

### Пример 2: Анализ чувствительности

Можно изменить начальные условия или параметры этапов в коде и проанализировать, как это влияет на оптимальную стратегию.

## Результаты выполнения

### Начальные данные

**Начальное состояние портфеля:**
- ЦБ1: 100.0 д.е.
- ЦБ2: 800.0 д.е.
- Депозиты: 400.0 д.е.
- Свободные средства: 600.0 д.е.
- **Общая стоимость: 1900.0 д.е.**

**Параметры управления:**
- Размер шага ЦБ1: 25.0 д.е. (1/4 от начальной стоимости)
- Размер шага ЦБ2: 200.0 д.е. (1/4 от начальной стоимости)
- Размер шага Депозиты: 100.0 д.е. (1/4 от начальной стоимости)

**Минимальные ограничения:**
- ЦБ1 >= 30.0 д.е.
- ЦБ2 >= 150.0 д.е.
- Депозиты >= 100.0 д.е.

**Комиссии брокеров:**
- ЦБ1: 4% (при покупке и продаже)
- ЦБ2: 7% (при покупке и продаже)
- Депозиты: 5% (при покупке и продаже)

### Результаты оптимизации

После выполнения программы методом динамического программирования получены следующие результаты:

**Максимальный ожидаемый доход (критерий Байеса):** 2015.94 д.е.

**Статистика вычислений:**
- Количество обработанных состояний: 2 173 092
- Размер кэша мемоизации: 4 735

### Оптимальная стратегия управления

#### Этап 1

**Действие:**
- ЦБ1: +3 шагов (+75.00 д.е.)
- ЦБ2: +1 шагов (+200.00 д.е.)

**Состояние после действия:**
- ЦБ1: 175.00 д.е.
- ЦБ2: 1000.00 д.е.
- Депозиты: 400.00 д.е.
- Свободные средства: 308.00 д.е.
- Общая стоимость: 1883.00 д.е.

**Ожидаемое состояние после применения ситуации:**
- Общая стоимость: 1984.53 д.е.

#### Этап 2

**Действие:**
- ЦБ1: +2 шагов (+50.00 д.е.)
- Депозиты: +1 шагов (+100.00 д.е.)

**Состояние после действия:**
- ЦБ1: 245.12 д.е.
- ЦБ2: 1061.00 д.е.
- Депозиты: 520.40 д.е.
- Свободные средства: 151.00 д.е.
- Общая стоимость: 1977.53 д.е.

**Ожидаемое состояние после применения ситуации:**
- Общая стоимость: 1956.62 д.е.

#### Этап 3

**Действие:**
- Без изменений

**Состояние после действия:**
- ЦБ1: 227.97 д.е.
- ЦБ2: 1055.69 д.е.
- Депозиты: 521.96 д.е.
- Свободные средства: 151.00 д.е.
- Общая стоимость: 1956.62 д.е.

**Ожидаемое состояние после применения ситуации:**
- Общая стоимость: 2015.94 д.е.

### Итоговые показатели

- **Итоговый ожидаемый доход:** 2015.94 д.е.
- **Прирост к начальной стоимости:** 115.94 д.е.
- **Процент прироста:** 6.10%

### Анализ результатов

На основе полученных результатов можно сделать следующие выводы:

1. **Эффективность стратегии:**
   - Оптимальная стратегия управления позволила увеличить стоимость портфеля с 1900.00 д.е. до 2015.94 д.е.
   - Прирост составил 115.94 д.е. (6.10%), что демонстрирует эффективность применения метода динамического программирования

2. **Характер оптимальных действий:**
   - **Этап 1:** Стратегия предполагает активное инвестирование свободных средств в ценные бумаги (увеличение ЦБ1 на 75 д.е. и ЦБ2 на 200 д.е.), что указывает на ожидание благоприятной рыночной конъюнктуры
   - **Этап 2:** Продолжается инвестирование в ЦБ1 (+50 д.е.) и депозиты (+100 д.е.), что говорит о диверсификации портфеля
   - **Этап 3:** Отсутствие действий (без изменений) может указывать на то, что текущая структура портфеля уже оптимальна для финального этапа

3. **Динамика стоимости портфеля:**
   - После этапа 1: ожидаемая стоимость увеличилась до 1984.53 д.е. (прирост 4.45%)
   - После этапа 2: ожидаемая стоимость снизилась до 1956.62 д.е. (снижение 1.41%), что может быть связано с неблагоприятными ситуациями на рынке
   - После этапа 3: ожидаемая стоимость достигла 2015.94 д.е. (прирост 3.03%), что компенсировало предыдущее снижение

4. **Эффективность оптимизаций:**
   - Применение дискретизации состояний и ограничения диапазона действий позволило обработать 2 173 092 состояния
   - Использование кэша мемоизации (4 735 уникальных состояний) значительно ускорило вычисления, исключив повторные расчеты

5. **Учет ограничений:**
   - Все действия соблюдают минимальные ограничения на активы
   - Комиссии брокеров учтены при всех операциях, что делает решение реалистичным
   - Свободные средства используются эффективно, но не превышаются доступные ресурсы

## Заключение

В ходе выполнения работы была решена многоэтапная задача оптимизации инвестиционного портфеля методом динамического программирования. 

### Что было сделано:

1. **Математическая постановка задачи:**
   - Определены состояния, управления и случайные параметры
   - Сформулированы ограничения и целевая функция
   - Выписано рекуррентное соотношение Беллмана

2. **Алгоритм решения:**
   - Реализован алгоритм обратного прохождения (backward induction)
   - Использована мемоизация для ускорения вычислений
   - Применен критерий Байеса для оценки ожидаемого дохода

3. **Программная реализация:**
   - Создан класс `InvestmentPortfolioOptimizer` для решения задачи
   - Реализованы функции генерации допустимых действий, применения управлений и ситуаций
   - Добавлена трассировка оптимального пути

### Чему удалось научиться:

1. **Динамическое программирование:**
   - Понимание принципа оптимальности Беллмана
   - Умение формулировать рекуррентные соотношения для многоэтапных задач
   - Реализация алгоритмов обратного прохождения

2. **Принятие решений в условиях неопределенности:**
   - Применение критерия Байеса для оценки ожидаемого дохода
   - Работа с вероятностными моделями многоэтапных процессов
   - Анализ влияния случайных факторов на оптимальную стратегию

3. **Оптимизация портфеля:**
   - Учет ограничений на управление (свободные средства, объемы активов)
   - Учет минимальных ограничений на активы (ЦБ1 >= 30, ЦБ2 >= 150, Депозиты >= 100)
   - Учет комиссий брокеров при покупке и продаже активов
   - Балансирование между риском и доходностью
   - Многоэтапное планирование инвестиций
